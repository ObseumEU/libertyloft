name: Build and Push Docker Images

on:
  push:
    branches:
      - main

jobs:
  # Job to generate the matrix of projects with Dockerfiles
  build-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate list of projects with Dockerfile
        id: set-matrix
        shell: bash
        run: |
          # Find all project directories containing a Dockerfile
          PROJECTS=$(find . -type f -name 'Dockerfile' -exec dirname {} \; | sort | uniq)
          echo "Found projects:"
          echo "$PROJECTS"

          # Convert the list into a JSON array for the matrix
          MATRIX=$(echo "$PROJECTS" | jq -R . | jq -s -c '{project: .}')
          echo "Matrix JSON:"
          echo "$MATRIX"

          # Set the matrix output
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

  # Job to build and push Docker images using the matrix strategy
  build-and-push:
    needs: build-matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false  # Continue running other jobs even if one fails
      matrix:
        project: ${{ fromJson(needs.build-matrix.outputs.matrix).project }}
    env:
      DOCKER_USER: ${{ secrets.DOCKER_SMIXERS_USER }}
      DOCKER_PASS: ${{ secrets.DOCKER_SMIXERS_SECRET }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ env.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ env.DOCKER_USER }}
          password: ${{ env.DOCKER_PASS }}

      - name: Build and push Docker image
        id: build_push
        shell: bash
        env:
          PROJECT_PATH: ${{ matrix.project }}
        run: |
          set -euo pipefail

<<<<<<< HEAD
          # For PROJECT_PATH=".", use repo name instead of basename(".") which is invalid for tags.
          if [ "$PROJECT_PATH" = "." ]; then
            PROJECT_NAME="${GITHUB_REPOSITORY##*/}"
          else
            PROJECT_NAME="$(basename "$PROJECT_PATH")"
          fi

          # Normalize to a valid docker repository component.
          PROJECT_NAME="$(echo "$PROJECT_NAME" \
            | tr '[:upper:]' '[:lower:]' \
            | sed -E 's/[^a-z0-9._-]+/-/g; s/^[._-]+//; s/[._-]+$//; s/-+/-/g')"

          if [ -z "$PROJECT_NAME" ]; then
            PROJECT_NAME="app"
          fi
=======
          # Explicitly map service images for stable production naming.
          case "$PROJECT_PATH" in
            ".")
              PROJECT_NAME="libertyloft-frontend"
              ;;
            "./server")
              PROJECT_NAME="libertyloft-backend"
              ;;
            *)
              PROJECT_NAME="$(basename "$PROJECT_PATH")"
              PROJECT_NAME="$(echo "$PROJECT_NAME" \
                | tr '[:upper:]' '[:lower:]' \
                | sed -E 's/[^a-z0-9._-]+/-/g; s/^[._-]+//; s/[._-]+$//; s/-+/-/g')"
              if [ -z "$PROJECT_NAME" ]; then
                PROJECT_NAME="app"
              fi
              ;;
          esac
>>>>>>> master

          IMAGE_NAME="${DOCKER_USER}/${PROJECT_NAME}:latest"

          echo "Building and pushing Docker image: $IMAGE_NAME"

          # Ensure the Dockerfile exists
          if [ ! -f "$PROJECT_PATH/Dockerfile" ]; then
            echo "Error: Dockerfile not found at $PROJECT_PATH/Dockerfile"
            exit 1
          fi

          # Build the Docker image and save logs
          if ! docker build -t "$IMAGE_NAME" -f "$PROJECT_PATH/Dockerfile" . > build.log 2>&1; then
            echo "Docker build failed"
            echo "=== Build Log ==="
            cat build.log
            exit 1
          fi

          # Push the Docker image and append logs
          if ! docker push "$IMAGE_NAME" >> build.log 2>&1; then
            echo "Docker push failed"
            echo "=== Build Log ==="
            cat build.log
            exit 1
          fi

          # Set the project name as an output for use in subsequent steps
          echo "project_name=$PROJECT_NAME" >> "$GITHUB_OUTPUT"

      - name: Upload build logs
        if: always()  # Always run, even if previous steps fail
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ steps.build_push.outputs.project_name }}
          path: build.log
